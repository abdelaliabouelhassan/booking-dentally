<template>
  <MainLayouts>
    <template v-slot:slides>
      <div class="mt-auto mb-1">
        <p class="uppercase text-theme-gold">Step 4</p>
        <h1 class="text-white text-3xl mb-1">Your details</h1>
      </div>
    </template>
    <template v-slot:current-options>
      <ul class="uppercase text-white marker:text-theme-gold list-disc">
        <li class="flex items-center space-x-2 text-xs">
          <span>{{ store.treatments.name }}</span>
          <svg
            width="10"
            height="10"
            viewBox="0 0 4 4"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <circle cx="1.85995" cy="2.03817" r="1.34237" fill="#BA812E" />
          </svg>
          <span>{{ store.practitioner.name }}</span>
          <svg
            width="10"
            height="10"
            viewBox="0 0 4 4"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <circle cx="1.85995" cy="2.03817" r="1.34237" fill="#BA812E" />
          </svg>
          <span>{{ formatDateToTime(store.availableTime.start_time) }}</span>
          <svg
            width="10"
            height="10"
            viewBox="0 0 4 4"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <circle cx="1.85995" cy="2.03817" r="1.34237" fill="#BA812E" />
          </svg>
          <span>{{ formateDate(store.availableTime.start_time) }}</span>
        </li>
      </ul>
    </template>
    <template v-slot:body>
      <div class="p-10 space-y-8">
        <h1 class="uppercase font-semibold">Your details</h1>

        <div class="w-full flex flex-col items-start space-y-4">
          <div class="w-full flex flex-col items-start space-y-1">
            <span class="text-xs font-medium text-red-600">{{
              errors.first_name
            }}</span>
            <input
              v-model="store.details.first_name"
              type="text"
              placeholder="First Name"
              class="
                text-xs
                font-bold
                text-[#525252]
                placeholder-[#D9D9D9]
                w-full
                py-4
                px-4
                outline-none
                rounded-full
                border-[0.5px] border-[#52525280]
                hover:border-[#BA812E]
                focus:border-[#BA812E]
              "
              :class="{ 'border-red-500': errors.first_name }"
            />
          </div>
          <div class="w-full flex flex-col items-start space-y-1">
            <span class="text-xs font-medium text-red-600">{{
              errors.last_name
            }}</span>
            <input
              v-model="store.details.last_name"
              type="text"
              placeholder="Last Name"
              class="
                text-xs
                font-bold
                text-[#525252]
                placeholder-[#D9D9D9]
                w-full
                py-4
                px-4
                outline-none
                rounded-full
                border-[0.5px] border-[#52525280]
                hover:border-[#BA812E]
                focus:border-[#BA812E]
              "
              :class="{ 'border-red-500': errors.last_name }"
            />
          </div>
          <div class="w-full flex flex-col items-start space-y-1">
            <span class="text-sm text-[#525252] font-bold">Date of birth</span>
            <div class="w-full grid grid-cols-3 gap-5">
              <div class="flex flex-col items-start space-y-1">
                <span class="text-xs font-medium text-red-600">{{
                  errors.day
                }}</span>
                <select
                  v-model="store.details.day"
                  name=""
                  id=""
                  class="
                    text-xs text-[#525252]
                    font-bold
                    placeholder-[#D9D9D9]
                    w-full
                    py-4
                    px-4
                    outline-none
                    rounded-full
                    border-[0.5px] border-[#52525280]
                    hover:border-[#BA812E]
                    focus:border-[#BA812E]
                  "
                  :class="{ 'border-red-500': errors.day }"
                >
                  <option value="" selected disabled>Day</option>
                  <option :value="item" v-for="item in days" :key="item">
                    {{ item }}
                  </option>
                </select>
              </div>
              <div class="flex flex-col items-start space-y-1">
                <span class="text-xs font-medium text-red-600">{{
                  errors.month
                }}</span>
                <select
                  v-model="store.details.month"
                  name=""
                  id=""
                  class="
                    text-xs text-[#525252]
                    font-bold
                    placeholder-[#D9D9D9]
                    w-full
                    py-4
                    px-4
                    outline-none
                    rounded-full
                    border-[0.5px] border-[#52525280]
                    hover:border-[#BA812E]
                    focus:border-[#BA812E]
                  "
                  :class="{ 'border-red-500': errors.month }"
                >
                  <option value="" selected disabled>Month</option>
                  <option :value="item" v-for="item in months" :key="item">
                    {{ item }}
                  </option>
                </select>
              </div>
              <div class="flex flex-col items-start space-y-1">
                <span class="text-xs font-medium text-red-600">{{
                  errors.year
                }}</span>
                <select
                  v-model="store.details.year"
                  name=""
                  id=""
                  class="
                    text-xs text-[#525252]
                    font-bold
                    placeholder-[#D9D9D9]
                    w-full
                    py-4
                    px-4
                    outline-none
                    rounded-full
                    border-[0.5px] border-[#52525280]
                    hover:border-[#BA812E]
                    focus:border-[#BA812E]
                  "
                  :class="{ 'border-red-500': errors.year }"
                >
                  <option value="" selected disabled>Year</option>
                  <option :value="item" v-for="item in years" :key="item">
                    {{ item }}
                  </option>
                </select>
              </div>
            </div>
          </div>
          <div class="w-full flex flex-col items-start space-y-1">
            <span class="text-xs font-medium text-red-600">{{
              errors.phone_number
            }}</span>
            <input
              v-model="store.details.phone_number"
              type="text"
              placeholder="Contact Number"
              class="
                text-xs
                font-bold
                text-[#525252]
                placeholder-[#D9D9D9]
                w-full
                py-4
                px-4
                outline-none
                rounded-full
                border-[0.5px] border-[#52525280]
                hover:border-[#BA812E]
                focus:border-[#BA812E]
              "
              :class="{ 'border-red-500': errors.phone_number }"
            />
          </div>
          <div class="w-full flex flex-col items-start space-y-1">
            <span class="text-xs font-medium text-red-600">{{
              errors.email
            }}</span>
            <input
              v-model="store.details.email"
              type="text"
              placeholder="Email Address"
              class="
                text-xs
                font-bold
                text-[#525252]
                placeholder-[#D9D9D9]
                w-full
                py-4
                px-4
                outline-none
                rounded-full
                border-[0.5px] border-[#52525280]
                hover:border-[#BA812E]
                focus:border-[#BA812E]
              "
              :class="{ 'border-red-500': errors.email }"
            />
          </div>
          <div class="w-full flex flex-col items-start space-y-1">
            <span class="text-xs font-medium text-red-600">{{
              errors.postcode
            }}</span>
            <input
              v-model="store.details.postcode"
              type="text"
              placeholder="Postcode"
              class="
                text-xs
                font-bold
                text-[#525252]
                placeholder-[#D9D9D9]
                w-full
                py-4
                px-4
                outline-none
                rounded-full
                border-[0.5px] border-[#52525280]
                hover:border-[#BA812E]
                focus:border-[#BA812E]
              "
              :class="{ 'border-red-500': errors.postcode }"
            />
          </div>
          <div class="w-full flex flex-col items-start space-y-1">
            <span class="text-xs font-medium text-red-600">{{
              errors.address
            }}</span>
            <input
              v-model="store.details.address"
              type="text"
              placeholder="Address"
              class="
                text-xs
                font-bold
                text-[#525252]
                placeholder-[#D9D9D9]
                w-full
                py-4
                px-4
                outline-none
                rounded-full
                border-[0.5px] border-[#52525280]
                hover:border-[#BA812E]
                focus:border-[#BA812E]
              "
              :class="{ 'border-red-500': errors.address }"
            />
          </div>
        </div>
      </div>
    </template>

    <template v-slot:pagination>
      <p class="text-theme-gray-light">5 of 5</p>
    </template>

    <template v-slot:buttons>
      <div class="space-x-4 flex flex-row">
        <a
          @click="goBack"
          href="javascript:void(0)"
          class="border-2 border-theme-gray rounded-full p-4 w-full"
          >Back</a
        >
        <a
          href="javascript:void(0)"
          @click="Confirm"
          class="
            bg-[#BA812E]
            hover:bg-opacity-90
            text-white
            rounded-full
            p-4
            w-full
          "
        >
          <LoadingSpiner v-if="loading" />
          <span v-else>Confirm and Book</span></a
        >
      </div>
    </template>
  </MainLayouts>
</template>


<script>
import MainLayouts from "@/components/layouts/MainLayouts.vue";
import LoadingSpiner from "@/components/icons/LoadingSpiner.vue";
import { useStore } from "@/stores/AppointmentStore.js";
export default {
  components: {
    MainLayouts,
    LoadingSpiner,
  },

  data() {
    return {
      loading: false,
      store: useStore(),
      days: [
        1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
        21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31,
      ],
      months: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
      years: [],
      sites: [],
      errors: [
        {
          first_name: "",
          last_name: "",
          email: "",
          phone_number: "",
          postcode: "",
          address: "",
          day: "",
          month: "",
          year: "",
        },
      ],
    };
  },
  methods: {
    CheckSteps() {
      if (this.store.step == 0) {
        this.$router.push({ path: "/" });
      }
    },
    validate() {
      this.errors = [];
      var valid = true;
      if (this.store.details.first_name == "") {
        this.errors.first_name = "First Name is required";
        valid = false;
      }
      if (this.store.details.last_name == "") {
        this.errors.last_name = "Last Name is required";
        valid = false;
      }
      //validate email format
      var re =
        /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      if (!re.test(this.store.details.email)) {
        this.errors.email = "Email is not valid";
        valid = false;
      }
      if (this.store.details.email == "") {
        this.errors.email = "Email is required";
        valid = false;
      }
      if (this.store.details.phone_number == "") {
        this.errors.phone_number = "Phone Number is required";
        valid = false;
      }
      if (this.store.details.postcode == "") {
        this.errors.postcode = "Postcode is required";
        valid = false;
      }
      if (this.store.details.address == "") {
        this.errors.address = "Address is required";
        valid = false;
      }
      if (this.store.details.day == "") {
        this.errors.day = "Day is required";
        valid = false;
      }
      if (this.store.details.month == "") {
        this.errors.month = "Month is required";
        valid = false;
      }
      if (this.store.details.year == "") {
        this.errors.year = "Year is required";
        valid = false;
      }

      return valid;
    },
    clearError() {
      this.errors = [
        {
          first_name: "",
          last_name: "",
          email: "",
          phone_number: "",
          postcode: "",
          address: "",
          day: "",
          month: "",
          year: "",
        },
      ];
    },
    formatDateToTime(date) {
      let hour = date.split("T")[1].split(":")[0];
      let minute = date.split("T")[1].split(":")[1];
      let ampm = hour >= 12 ? "PM" : "AM";
      hour = hour % 12;
      hour = hour ? hour : 12;
      minute = minute < 10 ? minute : minute;
      return hour + ":" + minute + " " + ampm;
    },
    formateDate(date) {
      let month = date.split("-")[1];
      let year = date.split("-")[0];
      let day = date.split("-")[2].split("T")[0];
      let monthName = new Date(year, month - 1, day).toLocaleString("en-us", {
        month: "long",
      });
      return monthName + " " + day + ", " + year;
    },
    goBack() {
      this.store.step--;
      this.$router.push({
        name: "available-slots",
      });
    },
    async Confirm() {
      if (this.loading) {
        return;
      }
      this.clearError();
      if (!this.validate()) {
        return;
      }
      this.loading = true;
      await this.axios
        .post("patients", {
          title: "Mr",
          first_name: this.store.details.first_name,
          last_name: this.store.details.last_name,
          date_of_birth:
            this.store.details.year +
            "-" +
            this.store.details.month +
            "-" +
            this.store.details.day,
          gender: true,
          ethnicity: "99",
          address_line_1: this.store.details.address,
          postcode: this.store.details.postcode,
          payment_plan_id: 4438,
          dentist_id: this.store.practitioner.id,
          email_address: this.store.details.email,
          mobile_phone: this.store.details.phone_number,
          home_phone: this.store.details.phone_number,
        })
        .then((response) => {
          //collect data
          this.store.details.id = response.data.patient.id;
          this.store.details.image = response.data.patient.image_url;
          //ceate appointment
          this.createaApointment();
          console.log(response.data);
        });
    },
    async createaApointment() {
      var start_date_time = this.store.availableTime.start_time;
      var finish_date_time = null;
      //add 30 minutes to finish_date_time
      var date = new Date(start_date_time);
      date.setMinutes(date.getMinutes() + 90);
      finish_date_time = date.toISOString();

      await this.axios
        .post("appointments", {
          start_time: this.store.availableTime.start_time,
          finish_time: finish_date_time,
          practitioner_id: this.store.practitioner.id,
          reason: "Dr Affan consultation new patient exam",
          patient_id: this.store.details.id,
        })
        .then((response) => {
          this.StoreData();
          console.log(response.data);
        });
    },
    async StoreData() {
      //change axsios base url
      this.axios.defaults.baseURL = "/api/";
      await this.axios
        .post("booked-record-store", {
          treatments: this.store.treatments,
          details: this.store.details,
          availableTime: this.store.availableTime,
          practitioner: this.store.practitioner,
        })
        .then((response) => {
          this.loading = false;
          console.log(response.data);
          //redirect to confirmation page
          this.$router.push({
            name: "confirmation",
          });
        })
        .catch((error) => {
          alert("something went wrong, please try again later");
        });
    },
    loadSite() {
      this.axios
        .get("sites/" + this.store.practitioner.site_id)
        .then((response) => {
          this.sites = response.data;
        });
    },
  },
  created() {
    this.CheckSteps();
    //set years 1950 - current year
    let currentYear = new Date().getFullYear();
    for (let i = 1950; i <= currentYear; i++) {
      this.years.push(i);
    }
  },
};
</script>